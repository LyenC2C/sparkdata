
hive<<EOF
-- use wlbase_dev;
-- drop table wlbase_dev.t_base_user_profile_telindex;
-- create table wlbase_dev.t_base_user_profile_telindex as
-- select
-- t1.tel_index,
-- t2.*
-- from
-- t_zlj_phone_rank_index t1
-- join
-- t_base_user_profile t2
-- on
-- t1.tb_id = t2.tb_id
-- and
-- t1.rn = 1
-- ;

drop table wlbase_dev.t_hx_model_yhhx_avgprice_tmp1;
create table wlbase_dev.t_hx_model_yhhx_avgprice_tmp1 as
select
a.tel_index,
b.cate_level1_id,
a.root_cat_name,
b.cat2,
c.price as cat_avg_price,
round(sum(a.price),2) as price,
count(*) as cnt,
round(sum(a.price)/count(*),2) as avg_price,
round(sum(a.price)/count(*),2)/c.price as price_ratio
from wlbase_dev.t_base_ec_record_dev_new_telindex_fix a
left join wlfinance.t_hx_ec_dim b on a.root_cat_id=b.cate_level1_id
left join wlbase_dev.t_root_cat_avg_price c on a.root_cat_id=c.root_cat_id
where c.price is not null and a.rn<4 and a.price<59999 and a.dsn >'20141231'
group by a.tel_index,b.cate_level1_id,a.root_cat_name,b.cat2,c.price;


drop table wlbase_dev.t_hx_model_yhhx_purchase_power;
create table wlbase_dev.t_hx_model_yhhx_purchase_power as
select
tel_index,
avg(price_ratio) as avg_price_ratio,
std(price_ratio) as std_price_ratio
from wlbase_dev.t_hx_model_yhhx_avgprice_tmp1
group by tel_index;


drop table wlbase_dev.t_hx_model_yhhx_cnt_raio;
create table wlbase_dev.t_hx_model_yhhx_cnt_raio as
select
tel_index,
sum(if (root_cat_id=11,1,0))/count(*) as cnt_ratio_11,
sum(if (root_cat_id=1101,1,0))/count(*) as cnt_ratio_1101,
sum(if (root_cat_id=1201,1,0))/count(*) as cnt_ratio_1201,
sum(if (root_cat_id=120886001,1,0))/count(*) as cnt_ratio_120886001,
sum(if (root_cat_id=120950002,1,0))/count(*) as cnt_ratio_120950002,
sum(if (root_cat_id=121266001,1,0))/count(*) as cnt_ratio_121266001,
sum(if (root_cat_id=121536003,1,0))/count(*) as cnt_ratio_121536003,
sum(if (root_cat_id=121536007,1,0))/count(*) as cnt_ratio_121536007,
sum(if (root_cat_id=122650005,1,0))/count(*) as cnt_ratio_122650005,
sum(if (root_cat_id=122684003,1,0))/count(*) as cnt_ratio_122684003,
sum(if (root_cat_id=122718004,1,0))/count(*) as cnt_ratio_122718004,
sum(if (root_cat_id=122852001,1,0))/count(*) as cnt_ratio_122852001,
sum(if (root_cat_id=122928002,1,0))/count(*) as cnt_ratio_122928002,
sum(if (root_cat_id=122950001,1,0))/count(*) as cnt_ratio_122950001,
sum(if (root_cat_id=122952001,1,0))/count(*) as cnt_ratio_122952001,
sum(if (root_cat_id=124024001,1,0))/count(*) as cnt_ratio_124024001,
sum(if (root_cat_id=124044001,1,0))/count(*) as cnt_ratio_124044001,
sum(if (root_cat_id=124050001,1,0))/count(*) as cnt_ratio_124050001,
sum(if (root_cat_id=124242008,1,0))/count(*) as cnt_ratio_124242008,
sum(if (root_cat_id=124354002,1,0))/count(*) as cnt_ratio_124354002,
sum(if (root_cat_id=124458005,1,0))/count(*) as cnt_ratio_124458005,
sum(if (root_cat_id=124466001,1,0))/count(*) as cnt_ratio_124466001,
sum(if (root_cat_id=124468001,1,0))/count(*) as cnt_ratio_124468001,
sum(if (root_cat_id=124470001,1,0))/count(*) as cnt_ratio_124470001,
sum(if (root_cat_id=124484008,1,0))/count(*) as cnt_ratio_124484008,
sum(if (root_cat_id=124750013,1,0))/count(*) as cnt_ratio_124750013,
sum(if (root_cat_id=14,1,0))/count(*) as cnt_ratio_14,
sum(if (root_cat_id=1512,1,0))/count(*) as cnt_ratio_1512,
sum(if (root_cat_id=16,1,0))/count(*) as cnt_ratio_16,
sum(if (root_cat_id=1625,1,0))/count(*) as cnt_ratio_1625,
sum(if (root_cat_id=1801,1,0))/count(*) as cnt_ratio_1801,
sum(if (root_cat_id=20,1,0))/count(*) as cnt_ratio_20,
sum(if (root_cat_id=21,1,0))/count(*) as cnt_ratio_21,
sum(if (root_cat_id=23,1,0))/count(*) as cnt_ratio_23,
sum(if (root_cat_id=25,1,0))/count(*) as cnt_ratio_25,
sum(if (root_cat_id=26,1,0))/count(*) as cnt_ratio_26,
sum(if (root_cat_id=27,1,0))/count(*) as cnt_ratio_27,
sum(if (root_cat_id=28,1,0))/count(*) as cnt_ratio_28,
sum(if (root_cat_id=2813,1,0))/count(*) as cnt_ratio_2813,
sum(if (root_cat_id=29,1,0))/count(*) as cnt_ratio_29,
sum(if (root_cat_id=30,1,0))/count(*) as cnt_ratio_30,
sum(if (root_cat_id=33,1,0))/count(*) as cnt_ratio_33,
sum(if (root_cat_id=34,1,0))/count(*) as cnt_ratio_34,
sum(if (root_cat_id=35,1,0))/count(*) as cnt_ratio_35,
sum(if (root_cat_id=40,1,0))/count(*) as cnt_ratio_40,
sum(if (root_cat_id=50002766,1,0))/count(*) as cnt_ratio_50002766,
sum(if (root_cat_id=50002768,1,0))/count(*) as cnt_ratio_50002768,
sum(if (root_cat_id=50004958,1,0))/count(*) as cnt_ratio_50004958,
sum(if (root_cat_id=50006842,1,0))/count(*) as cnt_ratio_50006842,
sum(if (root_cat_id=50006843,1,0))/count(*) as cnt_ratio_50006843,
sum(if (root_cat_id=50007216,1,0))/count(*) as cnt_ratio_50007216,
sum(if (root_cat_id=50007218,1,0))/count(*) as cnt_ratio_50007218,
sum(if (root_cat_id=50008075,1,0))/count(*) as cnt_ratio_50008075,
sum(if (root_cat_id=50008090,1,0))/count(*) as cnt_ratio_50008090,
sum(if (root_cat_id=50008141,1,0))/count(*) as cnt_ratio_50008141,
sum(if (root_cat_id=50008163,1,0))/count(*) as cnt_ratio_50008163,
sum(if (root_cat_id=50008164,1,0))/count(*) as cnt_ratio_50008164,
sum(if (root_cat_id=50008165,1,0))/count(*) as cnt_ratio_50008165,
sum(if (root_cat_id=50008907,1,0))/count(*) as cnt_ratio_50008907,
sum(if (root_cat_id=50010404,1,0))/count(*) as cnt_ratio_50010404,
sum(if (root_cat_id=50010728,1,0))/count(*) as cnt_ratio_50010728,
sum(if (root_cat_id=50010788,1,0))/count(*) as cnt_ratio_50010788,
sum(if (root_cat_id=50011397,1,0))/count(*) as cnt_ratio_50011397,
sum(if (root_cat_id=50011665,1,0))/count(*) as cnt_ratio_50011665,
sum(if (root_cat_id=50011699,1,0))/count(*) as cnt_ratio_50011699,
sum(if (root_cat_id=50011740,1,0))/count(*) as cnt_ratio_50011740,
sum(if (root_cat_id=50011949,1,0))/count(*) as cnt_ratio_50011949,
sum(if (root_cat_id=50011972,1,0))/count(*) as cnt_ratio_50011972,
sum(if (root_cat_id=50012029,1,0))/count(*) as cnt_ratio_50012029,
sum(if (root_cat_id=50012082,1,0))/count(*) as cnt_ratio_50012082,
sum(if (root_cat_id=50012100,1,0))/count(*) as cnt_ratio_50012100,
sum(if (root_cat_id=50012164,1,0))/count(*) as cnt_ratio_50012164,
sum(if (root_cat_id=50013864,1,0))/count(*) as cnt_ratio_50013864,
sum(if (root_cat_id=50013886,1,0))/count(*) as cnt_ratio_50013886,
sum(if (root_cat_id=50014811,1,0))/count(*) as cnt_ratio_50014811,
sum(if (root_cat_id=50014812,1,0))/count(*) as cnt_ratio_50014812,
sum(if (root_cat_id=50014927,1,0))/count(*) as cnt_ratio_50014927,
sum(if (root_cat_id=50016348,1,0))/count(*) as cnt_ratio_50016348,
sum(if (root_cat_id=50016349,1,0))/count(*) as cnt_ratio_50016349,
sum(if (root_cat_id=50016422,1,0))/count(*) as cnt_ratio_50016422,
sum(if (root_cat_id=50016891,1,0))/count(*) as cnt_ratio_50016891,
sum(if (root_cat_id=50017300,1,0))/count(*) as cnt_ratio_50017300,
sum(if (root_cat_id=50018004,1,0))/count(*) as cnt_ratio_50018004,
sum(if (root_cat_id=50018222,1,0))/count(*) as cnt_ratio_50018222,
sum(if (root_cat_id=50018264,1,0))/count(*) as cnt_ratio_50018264,
sum(if (root_cat_id=50019095,1,0))/count(*) as cnt_ratio_50019095,
sum(if (root_cat_id=50019780,1,0))/count(*) as cnt_ratio_50019780,
sum(if (root_cat_id=50020275,1,0))/count(*) as cnt_ratio_50020275,
sum(if (root_cat_id=50020332,1,0))/count(*) as cnt_ratio_50020332,
sum(if (root_cat_id=50020485,1,0))/count(*) as cnt_ratio_50020485,
sum(if (root_cat_id=50020579,1,0))/count(*) as cnt_ratio_50020579,
sum(if (root_cat_id=50020611,1,0))/count(*) as cnt_ratio_50020611,
sum(if (root_cat_id=50020808,1,0))/count(*) as cnt_ratio_50020808,
sum(if (root_cat_id=50020857,1,0))/count(*) as cnt_ratio_50020857,
sum(if (root_cat_id=50022517,1,0))/count(*) as cnt_ratio_50022517,
sum(if (root_cat_id=50022703,1,0))/count(*) as cnt_ratio_50022703,
sum(if (root_cat_id=50023282,1,0))/count(*) as cnt_ratio_50023282,
sum(if (root_cat_id=50023575,1,0))/count(*) as cnt_ratio_50023575,
sum(if (root_cat_id=50023717,1,0))/count(*) as cnt_ratio_50023717,
sum(if (root_cat_id=50023722,1,0))/count(*) as cnt_ratio_50023722,
sum(if (root_cat_id=50023724,1,0))/count(*) as cnt_ratio_50023724,
sum(if (root_cat_id=50023804,1,0))/count(*) as cnt_ratio_50023804,
sum(if (root_cat_id=50023878,1,0))/count(*) as cnt_ratio_50023878,
sum(if (root_cat_id=50023904,1,0))/count(*) as cnt_ratio_50023904,
sum(if (root_cat_id=50024451,1,0))/count(*) as cnt_ratio_50024451,
sum(if (root_cat_id=50024612,1,0))/count(*) as cnt_ratio_50024612,
sum(if (root_cat_id=50024971,1,0))/count(*) as cnt_ratio_50024971,
sum(if (root_cat_id=50025004,1,0))/count(*) as cnt_ratio_50025004,
sum(if (root_cat_id=50025110,1,0))/count(*) as cnt_ratio_50025110,
sum(if (root_cat_id=50025111,1,0))/count(*) as cnt_ratio_50025111,
sum(if (root_cat_id=50025705,1,0))/count(*) as cnt_ratio_50025705,
sum(if (root_cat_id=50025707,1,0))/count(*) as cnt_ratio_50025707,
sum(if (root_cat_id=50026316,1,0))/count(*) as cnt_ratio_50026316,
sum(if (root_cat_id=50026523,1,0))/count(*) as cnt_ratio_50026523,
sum(if (root_cat_id=50026555,1,0))/count(*) as cnt_ratio_50026555,
sum(if (root_cat_id=50026800,1,0))/count(*) as cnt_ratio_50026800,
sum(if (root_cat_id=50050359,1,0))/count(*) as cnt_ratio_50050359,
sum(if (root_cat_id=50050471,1,0))/count(*) as cnt_ratio_50050471,
sum(if (root_cat_id=50074001,1,0))/count(*) as cnt_ratio_50074001,
sum(if (root_cat_id=50158001,1,0))/count(*) as cnt_ratio_50158001,
sum(if (root_cat_id=50454031,1,0))/count(*) as cnt_ratio_50454031,
sum(if (root_cat_id=50468001,1,0))/count(*) as cnt_ratio_50468001,
sum(if (root_cat_id=50510002,1,0))/count(*) as cnt_ratio_50510002,
sum(if (root_cat_id=99,1,0))/count(*) as cnt_ratio_99
from wlbase_dev.t_base_ec_record_dev_new_telindex_fix
where rn<4 and price<59999
group by tel_index;



drop table  wlbase_dev.t_hx_model_yhhx_price_raio;
create table wlbase_dev.t_hx_model_yhhx_price_raio as
select
tel_index,
sum(if (root_cat_id=11,price,0))/sum(price) as price_ratio_11,
sum(if (root_cat_id=1101,price,0))/sum(price) as price_ratio_1101,
sum(if (root_cat_id=1201,price,0))/sum(price) as price_ratio_1201,
sum(if (root_cat_id=120886001,price,0))/sum(price) as price_ratio_120886001,
sum(if (root_cat_id=120950002,price,0))/sum(price) as price_ratio_120950002,
sum(if (root_cat_id=121266001,price,0))/sum(price) as price_ratio_121266001,
sum(if (root_cat_id=121536003,price,0))/sum(price) as price_ratio_121536003,
sum(if (root_cat_id=121536007,price,0))/sum(price) as price_ratio_121536007,
sum(if (root_cat_id=122650005,price,0))/sum(price) as price_ratio_122650005,
sum(if (root_cat_id=122684003,price,0))/sum(price) as price_ratio_122684003,
sum(if (root_cat_id=122718004,price,0))/sum(price) as price_ratio_122718004,
sum(if (root_cat_id=122852001,price,0))/sum(price) as price_ratio_122852001,
sum(if (root_cat_id=122928002,price,0))/sum(price) as price_ratio_122928002,
sum(if (root_cat_id=122950001,price,0))/sum(price) as price_ratio_122950001,
sum(if (root_cat_id=122952001,price,0))/sum(price) as price_ratio_122952001,
sum(if (root_cat_id=124024001,price,0))/sum(price) as price_ratio_124024001,
sum(if (root_cat_id=124044001,price,0))/sum(price) as price_ratio_124044001,
sum(if (root_cat_id=124050001,price,0))/sum(price) as price_ratio_124050001,
sum(if (root_cat_id=124242008,price,0))/sum(price) as price_ratio_124242008,
sum(if (root_cat_id=124354002,price,0))/sum(price) as price_ratio_124354002,
sum(if (root_cat_id=124458005,price,0))/sum(price) as price_ratio_124458005,
sum(if (root_cat_id=124466001,price,0))/sum(price) as price_ratio_124466001,
sum(if (root_cat_id=124468001,price,0))/sum(price) as price_ratio_124468001,
sum(if (root_cat_id=124470001,price,0))/sum(price) as price_ratio_124470001,
sum(if (root_cat_id=124484008,price,0))/sum(price) as price_ratio_124484008,
sum(if (root_cat_id=124750013,price,0))/sum(price) as price_ratio_124750013,
sum(if (root_cat_id=14,price,0))/sum(price) as price_ratio_14,
sum(if (root_cat_id=1512,price,0))/sum(price) as price_ratio_1512,
sum(if (root_cat_id=16,price,0))/sum(price) as price_ratio_16,
sum(if (root_cat_id=1625,price,0))/sum(price) as price_ratio_1625,
sum(if (root_cat_id=1801,price,0))/sum(price) as price_ratio_1801,
sum(if (root_cat_id=20,price,0))/sum(price) as price_ratio_20,
sum(if (root_cat_id=21,price,0))/sum(price) as price_ratio_21,
sum(if (root_cat_id=23,price,0))/sum(price) as price_ratio_23,
sum(if (root_cat_id=25,price,0))/sum(price) as price_ratio_25,
sum(if (root_cat_id=26,price,0))/sum(price) as price_ratio_26,
sum(if (root_cat_id=27,price,0))/sum(price) as price_ratio_27,
sum(if (root_cat_id=28,price,0))/sum(price) as price_ratio_28,
sum(if (root_cat_id=2813,price,0))/sum(price) as price_ratio_2813,
sum(if (root_cat_id=29,price,0))/sum(price) as price_ratio_29,
sum(if (root_cat_id=30,price,0))/sum(price) as price_ratio_30,
sum(if (root_cat_id=33,price,0))/sum(price) as price_ratio_33,
sum(if (root_cat_id=34,price,0))/sum(price) as price_ratio_34,
sum(if (root_cat_id=35,price,0))/sum(price) as price_ratio_35,
sum(if (root_cat_id=40,price,0))/sum(price) as price_ratio_40,
sum(if (root_cat_id=50002766,price,0))/sum(price) as price_ratio_50002766,
sum(if (root_cat_id=50002768,price,0))/sum(price) as price_ratio_50002768,
sum(if (root_cat_id=50004958,price,0))/sum(price) as price_ratio_50004958,
sum(if (root_cat_id=50006842,price,0))/sum(price) as price_ratio_50006842,
sum(if (root_cat_id=50006843,price,0))/sum(price) as price_ratio_50006843,
sum(if (root_cat_id=50007216,price,0))/sum(price) as price_ratio_50007216,
sum(if (root_cat_id=50007218,price,0))/sum(price) as price_ratio_50007218,
sum(if (root_cat_id=50008075,price,0))/sum(price) as price_ratio_50008075,
sum(if (root_cat_id=50008090,price,0))/sum(price) as price_ratio_50008090,
sum(if (root_cat_id=50008141,price,0))/sum(price) as price_ratio_50008141,
sum(if (root_cat_id=50008163,price,0))/sum(price) as price_ratio_50008163,
sum(if (root_cat_id=50008164,price,0))/sum(price) as price_ratio_50008164,
sum(if (root_cat_id=50008165,price,0))/sum(price) as price_ratio_50008165,
sum(if (root_cat_id=50008907,price,0))/sum(price) as price_ratio_50008907,
sum(if (root_cat_id=50010404,price,0))/sum(price) as price_ratio_50010404,
sum(if (root_cat_id=50010728,price,0))/sum(price) as price_ratio_50010728,
sum(if (root_cat_id=50010788,price,0))/sum(price) as price_ratio_50010788,
sum(if (root_cat_id=50011397,price,0))/sum(price) as price_ratio_50011397,
sum(if (root_cat_id=50011665,price,0))/sum(price) as price_ratio_50011665,
sum(if (root_cat_id=50011699,price,0))/sum(price) as price_ratio_50011699,
sum(if (root_cat_id=50011740,price,0))/sum(price) as price_ratio_50011740,
sum(if (root_cat_id=50011949,price,0))/sum(price) as price_ratio_50011949,
sum(if (root_cat_id=50011972,price,0))/sum(price) as price_ratio_50011972,
sum(if (root_cat_id=50012029,price,0))/sum(price) as price_ratio_50012029,
sum(if (root_cat_id=50012082,price,0))/sum(price) as price_ratio_50012082,
sum(if (root_cat_id=50012100,price,0))/sum(price) as price_ratio_50012100,
sum(if (root_cat_id=50012164,price,0))/sum(price) as price_ratio_50012164,
sum(if (root_cat_id=50013864,price,0))/sum(price) as price_ratio_50013864,
sum(if (root_cat_id=50013886,price,0))/sum(price) as price_ratio_50013886,
sum(if (root_cat_id=50014811,price,0))/sum(price) as price_ratio_50014811,
sum(if (root_cat_id=50014812,price,0))/sum(price) as price_ratio_50014812,
sum(if (root_cat_id=50014927,price,0))/sum(price) as price_ratio_50014927,
sum(if (root_cat_id=50016348,price,0))/sum(price) as price_ratio_50016348,
sum(if (root_cat_id=50016349,price,0))/sum(price) as price_ratio_50016349,
sum(if (root_cat_id=50016422,price,0))/sum(price) as price_ratio_50016422,
sum(if (root_cat_id=50016891,price,0))/sum(price) as price_ratio_50016891,
sum(if (root_cat_id=50017300,price,0))/sum(price) as price_ratio_50017300,
sum(if (root_cat_id=50018004,price,0))/sum(price) as price_ratio_50018004,
sum(if (root_cat_id=50018222,price,0))/sum(price) as price_ratio_50018222,
sum(if (root_cat_id=50018264,price,0))/sum(price) as price_ratio_50018264,
sum(if (root_cat_id=50019095,price,0))/sum(price) as price_ratio_50019095,
sum(if (root_cat_id=50019780,price,0))/sum(price) as price_ratio_50019780,
sum(if (root_cat_id=50020275,price,0))/sum(price) as price_ratio_50020275,
sum(if (root_cat_id=50020332,price,0))/sum(price) as price_ratio_50020332,
sum(if (root_cat_id=50020485,price,0))/sum(price) as price_ratio_50020485,
sum(if (root_cat_id=50020579,price,0))/sum(price) as price_ratio_50020579,
sum(if (root_cat_id=50020611,price,0))/sum(price) as price_ratio_50020611,
sum(if (root_cat_id=50020808,price,0))/sum(price) as price_ratio_50020808,
sum(if (root_cat_id=50020857,price,0))/sum(price) as price_ratio_50020857,
sum(if (root_cat_id=50022517,price,0))/sum(price) as price_ratio_50022517,
sum(if (root_cat_id=50022703,price,0))/sum(price) as price_ratio_50022703,
sum(if (root_cat_id=50023282,price,0))/sum(price) as price_ratio_50023282,
sum(if (root_cat_id=50023575,price,0))/sum(price) as price_ratio_50023575,
sum(if (root_cat_id=50023717,price,0))/sum(price) as price_ratio_50023717,
sum(if (root_cat_id=50023722,price,0))/sum(price) as price_ratio_50023722,
sum(if (root_cat_id=50023724,price,0))/sum(price) as price_ratio_50023724,
sum(if (root_cat_id=50023804,price,0))/sum(price) as price_ratio_50023804,
sum(if (root_cat_id=50023878,price,0))/sum(price) as price_ratio_50023878,
sum(if (root_cat_id=50023904,price,0))/sum(price) as price_ratio_50023904,
sum(if (root_cat_id=50024451,price,0))/sum(price) as price_ratio_50024451,
sum(if (root_cat_id=50024612,price,0))/sum(price) as price_ratio_50024612,
sum(if (root_cat_id=50024971,price,0))/sum(price) as price_ratio_50024971,
sum(if (root_cat_id=50025004,price,0))/sum(price) as price_ratio_50025004,
sum(if (root_cat_id=50025110,price,0))/sum(price) as price_ratio_50025110,
sum(if (root_cat_id=50025111,price,0))/sum(price) as price_ratio_50025111,
sum(if (root_cat_id=50025705,price,0))/sum(price) as price_ratio_50025705,
sum(if (root_cat_id=50025707,price,0))/sum(price) as price_ratio_50025707,
sum(if (root_cat_id=50026316,price,0))/sum(price) as price_ratio_50026316,
sum(if (root_cat_id=50026523,price,0))/sum(price) as price_ratio_50026523,
sum(if (root_cat_id=50026555,price,0))/sum(price) as price_ratio_50026555,
sum(if (root_cat_id=50026800,price,0))/sum(price) as price_ratio_50026800,
sum(if (root_cat_id=50050359,price,0))/sum(price) as price_ratio_50050359,
sum(if (root_cat_id=50050471,price,0))/sum(price) as price_ratio_50050471,
sum(if (root_cat_id=50074001,price,0))/sum(price) as price_ratio_50074001,
sum(if (root_cat_id=50158001,price,0))/sum(price) as price_ratio_50158001,
sum(if (root_cat_id=50454031,price,0))/sum(price) as price_ratio_50454031,
sum(if (root_cat_id=50468001,price,0))/sum(price) as price_ratio_50468001,
sum(if (root_cat_id=50510002,price,0))/sum(price) as price_ratio_50510002,
sum(if (root_cat_id=99,price,0))/sum(price) as price_ratio_99
from wlbase_dev.t_base_ec_record_dev_new_telindex_fix
where rn<4 and price<59999
group by tel_index;


drop table wlbase_dev.t_hx_model_yhhx_month_tmp1;
create table wlbase_dev.t_hx_model_yhhx_month_tmp1 as
select
tel_index,substr(dsn,1,6) as month,count(*) as cnt,sum(price) as price
from wlbase_dev.t_base_ec_record_dev_new_telindex_fix
where rn<4 and price<59999 and dsn>'20141231'
group by tel_index,substr(dsn,1,6) ;


drop table wlbase_dev.t_hx_model_yhhx_month_std;
create table wlbase_dev.t_hx_model_yhhx_month_std as
select
tel_index,
count(*) as buy_month,
avg(cnt) as avg_cnt,
std(cnt) as std_cnt,
avg(price) as avg_price,
std(price) as std_price
from wlbase_dev.t_hx_model_yhhx_month_tmp1
group by tel_index;


drop table wlbase_dev.t_hx_model_yhhx_finnal;
create table wlbase_dev.t_hx_model_yhhx_finnal as
SELECT
a.tel_index,
a.avg_price_ratio,
a.std_price_ratio,
b.cnt_ratio_11,
b.cnt_ratio_1101,
b.cnt_ratio_1201,
b.cnt_ratio_120886001,
b.cnt_ratio_120950002,
b.cnt_ratio_121266001,
b.cnt_ratio_121536003,
b.cnt_ratio_121536007,
b.cnt_ratio_122650005,
b.cnt_ratio_122684003,
b.cnt_ratio_122718004,
b.cnt_ratio_122852001,
b.cnt_ratio_122928002,
b.cnt_ratio_122950001,
b.cnt_ratio_122952001,
b.cnt_ratio_124024001,
b.cnt_ratio_124044001,
b.cnt_ratio_124050001,
b.cnt_ratio_124242008,
b.cnt_ratio_124354002,
b.cnt_ratio_124458005,
b.cnt_ratio_124466001,
b.cnt_ratio_124468001,
b.cnt_ratio_124470001,
b.cnt_ratio_124484008,
b.cnt_ratio_124750013,
b.cnt_ratio_14,
b.cnt_ratio_1512,
b.cnt_ratio_16,
b.cnt_ratio_1625,
b.cnt_ratio_1801,
b.cnt_ratio_20,
b.cnt_ratio_21,
b.cnt_ratio_23,
b.cnt_ratio_25,
b.cnt_ratio_26,
b.cnt_ratio_27,
b.cnt_ratio_28,
b.cnt_ratio_2813,
b.cnt_ratio_29,
b.cnt_ratio_30,
b.cnt_ratio_33,
b.cnt_ratio_34,
b.cnt_ratio_35,
b.cnt_ratio_40,
b.cnt_ratio_50002766,
b.cnt_ratio_50002768,
b.cnt_ratio_50004958,
b.cnt_ratio_50006842,
b.cnt_ratio_50006843,
b.cnt_ratio_50007216,
b.cnt_ratio_50007218,
b.cnt_ratio_50008075,
b.cnt_ratio_50008090,
b.cnt_ratio_50008141,
b.cnt_ratio_50008163,
b.cnt_ratio_50008164,
b.cnt_ratio_50008165,
b.cnt_ratio_50008907,
b.cnt_ratio_50010404,
b.cnt_ratio_50010728,
b.cnt_ratio_50010788,
b.cnt_ratio_50011397,
b.cnt_ratio_50011665,
b.cnt_ratio_50011699,
b.cnt_ratio_50011740,
b.cnt_ratio_50011949,
b.cnt_ratio_50011972,
b.cnt_ratio_50012029,
b.cnt_ratio_50012082,
b.cnt_ratio_50012100,
b.cnt_ratio_50012164,
b.cnt_ratio_50013864,
b.cnt_ratio_50013886,
b.cnt_ratio_50014811,
b.cnt_ratio_50014812,
b.cnt_ratio_50014927,
b.cnt_ratio_50016348,
b.cnt_ratio_50016349,
b.cnt_ratio_50016422,
b.cnt_ratio_50016891,
b.cnt_ratio_50017300,
b.cnt_ratio_50018004,
b.cnt_ratio_50018222,
b.cnt_ratio_50018264,
b.cnt_ratio_50019095,
b.cnt_ratio_50019780,
b.cnt_ratio_50020275,
b.cnt_ratio_50020332,
b.cnt_ratio_50020485,
b.cnt_ratio_50020579,
b.cnt_ratio_50020611,
b.cnt_ratio_50020808,
b.cnt_ratio_50020857,
b.cnt_ratio_50022517,
b.cnt_ratio_50022703,
b.cnt_ratio_50023282,
b.cnt_ratio_50023575,
b.cnt_ratio_50023717,
b.cnt_ratio_50023722,
b.cnt_ratio_50023724,
b.cnt_ratio_50023804,
b.cnt_ratio_50023878,
b.cnt_ratio_50023904,
b.cnt_ratio_50024451,
b.cnt_ratio_50024612,
b.cnt_ratio_50024971,
b.cnt_ratio_50025004,
b.cnt_ratio_50025110,
b.cnt_ratio_50025111,
b.cnt_ratio_50025705,
b.cnt_ratio_50025707,
b.cnt_ratio_50026316,
b.cnt_ratio_50026523,
b.cnt_ratio_50026555,
b.cnt_ratio_50026800,
b.cnt_ratio_50050359,
b.cnt_ratio_50050471,
b.cnt_ratio_50074001,
b.cnt_ratio_50158001,
b.cnt_ratio_50454031,
b.cnt_ratio_50468001,
b.cnt_ratio_50510002,
b.cnt_ratio_99,
c.price_ratio_11,
c.price_ratio_1101,
c.price_ratio_1201,
c.price_ratio_120886001,
c.price_ratio_120950002,
c.price_ratio_121266001,
c.price_ratio_121536003,
c.price_ratio_121536007,
c.price_ratio_122650005,
c.price_ratio_122684003,
c.price_ratio_122718004,
c.price_ratio_122852001,
c.price_ratio_122928002,
c.price_ratio_122950001,
c.price_ratio_122952001,
c.price_ratio_124024001,
c.price_ratio_124044001,
c.price_ratio_124050001,
c.price_ratio_124242008,
c.price_ratio_124354002,
c.price_ratio_124458005,
c.price_ratio_124466001,
c.price_ratio_124468001,
c.price_ratio_124470001,
c.price_ratio_124484008,
c.price_ratio_124750013,
c.price_ratio_14,
c.price_ratio_1512,
c.price_ratio_16,
c.price_ratio_1625,
c.price_ratio_1801,
c.price_ratio_20,
c.price_ratio_21,
c.price_ratio_23,
c.price_ratio_25,
c.price_ratio_26,
c.price_ratio_27,
c.price_ratio_28,
c.price_ratio_2813,
c.price_ratio_29,
c.price_ratio_30,
c.price_ratio_33,
c.price_ratio_34,
c.price_ratio_35,
c.price_ratio_40,
c.price_ratio_50002766,
c.price_ratio_50002768,
c.price_ratio_50004958,
c.price_ratio_50006842,
c.price_ratio_50006843,
c.price_ratio_50007216,
c.price_ratio_50007218,
c.price_ratio_50008075,
c.price_ratio_50008090,
c.price_ratio_50008141,
c.price_ratio_50008163,
c.price_ratio_50008164,
c.price_ratio_50008165,
c.price_ratio_50008907,
c.price_ratio_50010404,
c.price_ratio_50010728,
c.price_ratio_50010788,
c.price_ratio_50011397,
c.price_ratio_50011665,
c.price_ratio_50011699,
c.price_ratio_50011740,
c.price_ratio_50011949,
c.price_ratio_50011972,
c.price_ratio_50012029,
c.price_ratio_50012082,
c.price_ratio_50012100,
c.price_ratio_50012164,
c.price_ratio_50013864,
c.price_ratio_50013886,
c.price_ratio_50014811,
c.price_ratio_50014812,
c.price_ratio_50014927,
c.price_ratio_50016348,
c.price_ratio_50016349,
c.price_ratio_50016422,
c.price_ratio_50016891,
c.price_ratio_50017300,
c.price_ratio_50018004,
c.price_ratio_50018222,
c.price_ratio_50018264,
c.price_ratio_50019095,
c.price_ratio_50019780,
c.price_ratio_50020275,
c.price_ratio_50020332,
c.price_ratio_50020485,
c.price_ratio_50020579,
c.price_ratio_50020611,
c.price_ratio_50020808,
c.price_ratio_50020857,
c.price_ratio_50022517,
c.price_ratio_50022703,
c.price_ratio_50023282,
c.price_ratio_50023575,
c.price_ratio_50023717,
c.price_ratio_50023722,
c.price_ratio_50023724,
c.price_ratio_50023804,
c.price_ratio_50023878,
c.price_ratio_50023904,
c.price_ratio_50024451,
c.price_ratio_50024612,
c.price_ratio_50024971,
c.price_ratio_50025004,
c.price_ratio_50025110,
c.price_ratio_50025111,
c.price_ratio_50025705,
c.price_ratio_50025707,
c.price_ratio_50026316,
c.price_ratio_50026523,
c.price_ratio_50026555,
c.price_ratio_50026800,
c.price_ratio_50050359,
c.price_ratio_50050471,
c.price_ratio_50074001,
c.price_ratio_50158001,
c.price_ratio_50454031,
c.price_ratio_50468001,
c.price_ratio_50510002,
c.price_ratio_99,
d.buy_month,
d.avg_cnt,
d.std_cnt,
d.avg_price,
d.std_price
from  wlbase_dev.t_hx_model_yhhx_purchase_power a
left join wlbase_dev.t_hx_model_yhhx_cnt_raio b on a.tel_index=b.tel_index
left join wlbase_dev.t_hx_model_yhhx_price_raio c on a.tel_index=c.tel_index
left join wlbase_dev.t_hx_model_yhhx_month_std d on a.tel_index=d.tel_index;


DROP  table t_base_ec_record_dev_new_yhhx_feature_zlj ;
create table  t_base_ec_record_dev_new_yhhx_feature_zlj as
SELECT
tel_index as id ,
max(user_id) as user_id ,
COUNT(1) as local_buycount ,
sum(price) as total_price,
sum( case when root_cat_id IN  ( 26, 50016768, 50024971, 124470006  ) then 1 else 0 end) as car_flag ,
sum( case when root_cat_id IN  ( 27,  50008164,50020332,50020808, 50022649,50022703, 50022987,50023804,50025881, 122852001,123302001,124698018  ) then 1 else 0 end)
as house_flag ,
sum( case when root_cat_id IN  (25 ,50008165,122650005  ) then 1 else 0 end) as child_flag ,
sum( case when root_cat_id IN  (29 ) then 1 else 0 end) as pet_flag ,
  sum(CASE WHEN annoy = '1'       THEN 1        ELSE 0 END)     as        annoy_num,
  sum(CASE WHEN annoy = '1'       THEN 1        ELSE 0 END)/COUNT(1) as  annoy_ratio,
   COUNT(DISTINCT brand_id)  as  brand_id_num,
   COUNT(DISTINCT root_cat_id) as root_cat_id_num,
   sum(CASE WHEN bc_type = 'B'       THEN 1         ELSE 0 END)       as          b_bc_type_num,
   sum(CASE WHEN bc_type = 'B'       THEN 1         ELSE 0 END)/COUNT(1)      as     b_bc_type_num_ratio,
   sum(CASE WHEN bc_type = 'B'       THEN price         ELSE 0 END)/sum(price)   as  b_bc_price_ratio,
   sum(CASE WHEN CAST (brand_id as bigint )>10       THEN price         ELSE 0 END)/sum(price)  as  brand_effec_price_ratio,
   sum(CASE WHEN CAST (brand_id as bigint )>10     THEN 1        ELSE 0 END)/COUNT(1)    as        brand_effec_num_ratio,
   sum(case when price <=50 then 1 else 0 end)/count(*) as b50_num_ratio,
   sum(case when price <=50 then price else 0 end)/sum(price ) as b50_ratio
from wlbase_dev.t_base_ec_record_dev_new_telindex_fix where rn<4 and price<59999
group by tel_index
;

EOF